<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GroovTube Ontvanger Instellingen</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }
        .header img {
            height: 60px;
            margin-right: 20px;
        }
        h1 {
            color: #2c3e50;
            margin: 0;
        }
        .status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .control-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .control-group h2 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.2em;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
        }
        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }
        .value-display {
            font-family: monospace;
            color: #2c3e50;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .checkbox-wrapper {
            margin: 10px 0;
        }
        #connectionButton {
            margin-bottom: 20px;
        }
        select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background-color: white;
        }
        .sub-control {
            margin-left: 20px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .mode-specific {
            display: none;
        }
        .mode-specific.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>GroovTube Instellingen</h1>
        </div>

        <button id="connectionButton">Verbind met Apparaat</button>

        <div id="statusDisplay" class="status disconnected">
            Niet verbonden met apparaat
        </div>

        <div id="liveBreathData" class="status" style="margin-bottom:20px;">
            <b>Ruwe ademhalingswaarde:</b> <span id="breathValueLive">-</span>
        </div>

        <div id="controls" style="display: none;">
            <div class="control-group">
                <h2>Besturingsmodus</h2>
                <select id="controlMode">
                    <option value="joystick">Joystick</option>
                    <option value="buttons">Knoppen</option>
                </select>
            </div>

            <div id="joystickControls" class="mode-specific active">
                <div class="control-group">
                    <h2>Dode Zone</h2>
                    <p>Minimale ademwaarde voordat de joystick beweegt</p>
                    <input type="range" id="deadzone" min="0.01" max="0.1" step="0.01" value="0.05">
                    <div class="value-display">Waarde: <span id="deadzoneValue">0.05</span></div>
                </div>

                <div class="control-group">
                    <h2>Gevoeligheid</h2>
                    <p>Hoe snel de joystick reageert op ademveranderingen</p>
                    <input type="range" id="sensitivity" min="1.0" max="5.0" step="0.1" value="2.0">
                    <div class="value-display">Waarde: <span id="sensitivityValue">2.0</span></div>
                </div>

                <div class="control-group">
                    <h2>Blazen Richting</h2>
                    <select id="blowDirection">
                        <option value="up">Omhoog</option>
                        <option value="down">Omlaag</option>
                        <option value="left">Links</option>
                        <option value="right">Rechts</option>
                    </select>
                </div>

                <div class="control-group">
                    <h2>Inademen Richting</h2>
                    <select id="inhaleDirection">
                        <option value="down">Omlaag</option>
                        <option value="up">Omhoog</option>
                        <option value="left">Links</option>
                        <option value="right">Rechts</option>
                    </select>
                </div>
            </div>

            <div id="buttonControls" class="mode-specific">
                <div class="control-group">
                    <h2>Blazen Knop</h2>
                    <select id="blowButton">
                        <option value="none">Geen</option>
                        <option value="1">A</option>
                        <option value="2">B</option>
                        <option value="3">X</option>
                        <option value="4">Y</option>
                        <option value="5">RB</option>
                        <option value="6">R</option>
                        <option value="7">LB</option>
                        <option value="8">L</option>
                    </select>
                    <div class="sub-control">
                        <label>Drempelwaarde voor Blazen</label>
                        <input type="range" id="blowThreshold" min="0.1" max="1.0" step="0.05" value="0.5">
                        <div class="value-display">Waarde: <span id="blowThresholdValue">0.5</span></div>
                    </div>
                </div>

                <div class="control-group">
                    <h2>Inademen Knop</h2>
                    <select id="inhaleButton">
                        <option value="none">Geen</option>
                        <option value="1">A</option>
                        <option value="2">B</option>
                        <option value="3">X</option>
                        <option value="4">Y</option>
                        <option value="5">RB</option>
                        <option value="6">R</option>
                        <option value="7">LB</option>
                        <option value="8">L</option>
                    </select>
                    <div class="sub-control">
                        <label>Drempelwaarde voor Inademen</label>
                        <input type="range" id="inhaleThreshold" min="0.1" max="1.0" step="0.05" value="0.5">
                        <div class="value-display">Waarde: <span id="inhaleThresholdValue">0.5</span></div>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <h2>Ademhalingsmeting</h2>
                <button id="measureButton">Start Meting</button>
                <div id="measurementResults" style="display: none; margin-top: 15px;">
                    <h3>Meting Resultaten</h3>
                    <p>Hoogste uitademing: <span id="maxExhale">-</span></p>
                    <p>Laagste inademing: <span id="minInhale">-</span></p>
                    <p>Langste uitademing: <span id="longestExhale">-</span> seconden</p>
                    <p>Langste inademing: <span id="longestInhale">-</span> seconden</p>
                </div>
            </div>

             <div class="control-group">
                <h2>GPIO Trigger Instellingen</h2>
                <div class="sub-control">
                    <label>Uitademen Drempelwaarde</label>
                    <input type="range" id="blowGpioThreshold" min="0.1" max="1.0" step="0.1" value="0.7">
                    <div class="value-display">Waarde: <span id="blowGpioThresholdValue">0.7</span></div>
                </div>
                <div class="sub-control">
                    <label>Inademen Drempelwaarde</label>
                    <input type="range" id="inhaleGpioThreshold" min="-1.0" max="-0.1" step="0.1" value="-0.7">
                    <div class="value-display">Waarde: <span id="inhaleGpioThresholdValue">-0.7</span></div>
                </div>
            </div>

            <div class="control-group">
                <h2>LED Ring Instellingen</h2>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="ledEnabled" checked>
                    <label for="ledEnabled">LED Ring inschakelen</label>
                </div>
                <div class="sub-control">
                    <label>Start Helderheid (%)</label>
                    <input type="range" id="ledStartBrightness" min="1" max="50" step="1" value="5">
                    <div class="value-display">Waarde: <span id="ledStartBrightnessValue">5</span>%</div>
                </div>
                <div class="sub-control">
                    <label>Kleur Modus</label>
                    <select id="ledColorMode">
                        <option value="rainbow">Regenboog</option>
                        <option value="single">Enkele kleur</option>
                        <option value="breathing">Ademhaling effect</option>
                    </select>
                </div>
                <div class="sub-control" id="singleColorPicker" style="display: none;">
                    <label>Enkele kleur</label>
                    <input type="color" id="ledSingleColor" value="#ff0000">
                </div>
            </div>

            <div class="control-group">
                <h2>PEP Modus (Positieve Uitadem Druk)</h2>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="pepModeEnabled">
                    <label for="pepModeEnabled">PEP Modus inschakelen</label>
                </div>
                <div class="sub-control">
                    <label>PEP Doelwaarde</label>
                    <input type="range" id="pepTargetValue" min="0.3" max="1.0" step="0.05" value="0.8">
                    <div class="value-display">Waarde: <span id="pepTargetValueDisplay">0.8</span></div>
                </div>
                <div class="sub-control">
                    <label>Succes Tijd (seconden)</label>
                    <input type="range" id="pepHoldTime" min="1" max="10" step="0.5" value="2">
                    <div class="value-display">Waarde: <span id="pepHoldTimeDisplay">2</span> sec</div>
                </div>
                <div class="sub-control">
                    <label>Start Helderheid (%)</label>
                    <input type="range" id="pepStartBrightness" min="10" max="80" step="5" value="30">
                    <div class="value-display">Waarde: <span id="pepStartBrightnessValue">30</span>%</div>
                </div>
                <div class="sub-control">
                    <label>Maximum Helderheid (%)</label>
                    <input type="range" id="pepMaxBrightness" min="50" max="100" step="5" value="100">
                    <div class="value-display">Waarde: <span id="pepMaxBrightnessValue">100</span>%</div>
                </div>
                <div class="sub-control">
                    <label>Aantal Knipperingen bij Succes</label>
                    <input type="range" id="pepBlinkTimes" min="1" max="10" step="1" value="3">
                    <div class="value-display">Waarde: <span id="pepBlinkTimesValue">3</span> keer</div>
                </div>
                <div class="sub-control">
                    <label>Knippersnelheid (seconden)</label>
                    <input type="range" id="pepBlinkSpeed" min="0.1" max="1.0" step="0.1" value="0.2">
                    <div class="value-display">Waarde: <span id="pepBlinkSpeedValue">0.2</span> sec</div>
                </div>
            </div>

            <div class="control-group">
                <h2>MP3 Speler Instellingen</h2>
                <p><strong>DFPlayer Mini Aansluitingen:</strong><br>
                   TX (naar RP2040) → GP4<br>
                   RX (van RP2040) → GP5<br>
                   VCC → 3.3V of 5V<br>
                   GND → GND<br>
                   SPK+ en SPK- → Luidspreker (3-5W, 4-8Ω)</p>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="dfplayerEnabled">
                    <label for="dfplayerEnabled">MP3 Speler inschakelen</label>
                </div>
                <div class="sub-control">
                    <label>Minimaal Volume</label>
                    <input type="range" id="minVolume" min="0" max="30" step="1" value="5">
                    <div class="value-display">Waarde: <span id="minVolumeValue">5</span></div>
                </div>
                <div class="sub-control">
                    <label>Maximaal Volume</label>
                    <input type="range" id="maxVolume" min="0" max="30" step="1" value="30">
                    <div class="value-display">Waarde: <span id="maxVolumeValue">30</span></div>
                </div>
                <div class="sub-control">
                    <label>Inademen drempel voor volgend nummer</label>
                    <input type="range" id="trackChangeThreshold" min="-1.0" max="-0.1" step="0.1" value="-0.5">
                    <div class="value-display">Waarde: <span id="trackChangeThresholdValue">-0.5</span></div>
                </div>
            </div>

            <button id="saveButton">Instellingen Opslaan</button>
            <button id="exportButton" style="margin-left: 10px;">Instellingen Exporteren</button>
            
            <div class="control-group" style="margin-top: 20px;">
                <h2>Handmatige Import/Export</h2>
                <p>Kopieer en plak JSON instellingen voor backup/restore:</p>
                <textarea id="importTextarea" placeholder="Plak hier je JSON instellingen..." style="width: 100%; height: 100px; margin: 10px 0; font-family: monospace; font-size: 12px;"></textarea>
                <button id="importButton">Instellingen Importeren</button>
                <button id="copyExportButton" style="margin-left: 10px;">Kopieer Huidige Instellingen</button>
            </div>
        </div>
    </div>

    <script>
        let port;
        let reader;
        let writer;
        let lineBuffer = ''; // <<<<<<< NIEUW: Buffer voor inkomende data
        const encoder = new TextEncoder();
        const decoder = new TextDecoder();

        // UI Elements (rest is ongewijzigd)
        const connectionButton = document.getElementById('connectionButton');
        const statusDisplay = document.getElementById('statusDisplay');
        const controls = document.getElementById('controls');
        const saveButton = document.getElementById('saveButton');
        const exportButton = document.getElementById('exportButton');
        const importButton = document.getElementById('importButton');
        const copyExportButton = document.getElementById('copyExportButton');
        const importTextarea = document.getElementById('importTextarea');
        const controlMode = document.getElementById('controlMode');
        const joystickControls = document.getElementById('joystickControls');
        const buttonControls = document.getElementById('buttonControls');
        const deadzone = document.getElementById('deadzone');
        const deadzoneValue = document.getElementById('deadzoneValue');
        const sensitivity = document.getElementById('sensitivity');
        const sensitivityValue = document.getElementById('sensitivityValue');
        const blowDirection = document.getElementById('blowDirection');
        const inhaleDirection = document.getElementById('inhaleDirection');
        const breathValueLive = document.getElementById('breathValueLive');
        const measureButton = document.getElementById('measureButton');
        const measurementResults = document.getElementById('measurementResults');
        const maxExhaleDisplay = document.getElementById('maxExhale');
        const minInhaleDisplay = document.getElementById('minInhale');
        const longestExhaleDisplay = document.getElementById('longestExhale');
        const longestInhaleDisplay = document.getElementById('longestInhale');
        const dfplayerEnabled = document.getElementById('dfplayerEnabled');
        const minVolume = document.getElementById('minVolume');
        const maxVolume = document.getElementById('maxVolume');
        const minVolumeValue = document.getElementById('minVolumeValue');
        const maxVolumeValue = document.getElementById('maxVolumeValue');
        const blowGpioThreshold = document.getElementById('blowGpioThreshold');
        const inhaleGpioThreshold = document.getElementById('inhaleGpioThreshold');
        const blowGpioThresholdValue = document.getElementById('blowGpioThresholdValue');
        const inhaleGpioThresholdValue = document.getElementById('inhaleGpioThresholdValue');

        // Nieuwe UI elementen
        const blowButton = document.getElementById('blowButton');
        const inhaleButton = document.getElementById('inhaleButton');
        const blowThreshold = document.getElementById('blowThreshold');
        const blowThresholdValue = document.getElementById('blowThresholdValue');
        const inhaleThreshold = document.getElementById('inhaleThreshold');
        const inhaleThresholdValue = document.getElementById('inhaleThresholdValue');
        
        // LED instellingen
        const ledEnabled = document.getElementById('ledEnabled');
        const ledStartBrightness = document.getElementById('ledStartBrightness');
        const ledStartBrightnessValue = document.getElementById('ledStartBrightnessValue');
        const ledColorMode = document.getElementById('ledColorMode');
        const ledSingleColor = document.getElementById('ledSingleColor');
        const singleColorPicker = document.getElementById('singleColorPicker');
        
        // PEP modus
        const pepModeEnabled = document.getElementById('pepModeEnabled');
        const pepTargetValue = document.getElementById('pepTargetValue');
        const pepTargetValueDisplay = document.getElementById('pepTargetValueDisplay');
        const pepHoldTime = document.getElementById('pepHoldTime');
        const pepHoldTimeDisplay = document.getElementById('pepHoldTimeDisplay');
        const pepStartBrightness = document.getElementById('pepStartBrightness');
        const pepStartBrightnessValue = document.getElementById('pepStartBrightnessValue');
        const pepMaxBrightness = document.getElementById('pepMaxBrightness');
        const pepMaxBrightnessValue = document.getElementById('pepMaxBrightnessValue');
        const pepBlinkTimes = document.getElementById('pepBlinkTimes');
        const pepBlinkTimesValue = document.getElementById('pepBlinkTimesValue');
        const pepBlinkSpeed = document.getElementById('pepBlinkSpeed');
        const pepBlinkSpeedValue = document.getElementById('pepBlinkSpeedValue');
        
        // MP3 speler
        const trackChangeThreshold = document.getElementById('trackChangeThreshold');
        const trackChangeThresholdValue = document.getElementById('trackChangeThresholdValue');

        let isMeasuring = false;

        // Update value displays voor alle nieuwe elementen
        deadzone.oninput = () => deadzoneValue.textContent = deadzone.value;
        sensitivity.oninput = () => sensitivityValue.textContent = sensitivity.value;
        blowThreshold.oninput = () => blowThresholdValue.textContent = blowThreshold.value;
        inhaleThreshold.oninput = () => inhaleThresholdValue.textContent = inhaleThreshold.value;
        minVolume.oninput = () => minVolumeValue.textContent = minVolume.value;
        maxVolume.oninput = () => maxVolumeValue.textContent = maxVolume.value;
        blowGpioThreshold.oninput = () => blowGpioThresholdValue.textContent = blowGpioThreshold.value;
        inhaleGpioThreshold.oninput = () => inhaleGpioThresholdValue.textContent = inhaleGpioThreshold.value;
        ledStartBrightness.oninput = () => ledStartBrightnessValue.textContent = ledStartBrightness.value;
        pepTargetValue.oninput = () => pepTargetValueDisplay.textContent = pepTargetValue.value;
        pepHoldTime.oninput = () => pepHoldTimeDisplay.textContent = pepHoldTime.value;
        pepStartBrightness.oninput = () => pepStartBrightnessValue.textContent = pepStartBrightness.value;
        pepMaxBrightness.oninput = () => pepMaxBrightnessValue.textContent = pepMaxBrightness.value;
        pepBlinkTimes.oninput = () => pepBlinkTimesValue.textContent = pepBlinkTimes.value;
        pepBlinkSpeed.oninput = () => pepBlinkSpeedValue.textContent = pepBlinkSpeed.value;
        trackChangeThreshold.oninput = () => trackChangeThresholdValue.textContent = trackChangeThreshold.value;
        
        // LED color mode switching
        ledColorMode.onchange = () => {
            singleColorPicker.style.display = ledColorMode.value === 'single' ? 'block' : 'none';
        };
        
        controlMode.onchange = () => {
            joystickControls.classList.toggle('active', controlMode.value === 'joystick');
            buttonControls.classList.toggle('active', controlMode.value === 'buttons');
        };

        async function connect() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                
                reader = port.readable.getReader();
                writer = port.writable.getWriter();
                
                connectionButton.textContent = 'Verbinding Verbreken';
                statusDisplay.textContent = 'Verbonden met apparaat';
                statusDisplay.className = 'status connected';
                controls.style.display = 'block';
                
                await sendCommand('GET:settings');
                readLoop();
                
            } catch (error) {
                console.error('Connection error:', error);
                statusDisplay.textContent = 'Verbinding mislukt: ' + error.message;
                statusDisplay.className = 'status disconnected';
            }
        }

        async function disconnect() {
            if (reader) {
                await reader.cancel();
                await reader.releaseLock();
            }
            if (writer) {
                await writer.releaseLock();
            }
            if (port) {
                await port.close();
            }
            
            connectionButton.textContent = 'Verbind met Apparaat';
            statusDisplay.textContent = 'Niet verbonden met apparaat';
            statusDisplay.className = 'status disconnected';
            controls.style.display = 'none';
            
            port = null;
            reader = null;
            writer = null;
            lineBuffer = ''; // Reset buffer on disconnect
        }

        async function sendCommand(command) {
            console.log("Sending command:", command);
            if (writer) {
                const encodedCommand = encoder.encode(command + '\n');
                console.log("Encoded bytes:", Array.from(encodedCommand));
                await writer.write(encodedCommand);
            }
        }

        // <<<<<<< AANGEPAST: readLoop met line buffer
        async function readLoop() {
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) {
                        break;
                    }
                    
                    // Voeg nieuwe data toe aan de buffer
                    lineBuffer += decoder.decode(value, { stream: true });
                    
                    // Verwerk elke complete regel in de buffer
                    let newlineIndex;
                    while ((newlineIndex = lineBuffer.indexOf('\n')) !== -1) {
                        const line = lineBuffer.slice(0, newlineIndex).trim();
                        lineBuffer = lineBuffer.slice(newlineIndex + 1);
                        if (line) {
                            handleResponseLine(line);
                        }
                    }
                }
            } catch (error) {
                console.error('Read error:', error);
                await disconnect();
            }
        }

        // <<<<<<< AANGEPAST: Verwerkt nu één complete regel per keer
        function handleResponseLine(line) {
            console.log("Received line:", line);
            // Gebruik '::' als primaire scheidingsteken voor JSON data
            const parts = line.split('::');
            const commandParts = parts[0].split(':');
            const type = commandParts[0];

            if (type === 'SETTINGS' && parts.length > 1) {
                try {
                    const settings = JSON.parse(parts[1]);
                    updateUiWithSettings(settings);
                } catch (e) {
                    console.error('Error parsing settings JSON:', e);
                }
            } else if (type === 'BREATH_DATA' && commandParts.length > 1) {
                const value = commandParts[1];
                breathValueLive.textContent = parseFloat(value).toFixed(3);
            } else if (type === 'MEASUREMENTS' && parts.length > 1) {
                try {
                    const data = JSON.parse(parts[1]);
                    maxExhaleDisplay.textContent = (data.max_exhale > -Infinity) ? data.max_exhale.toFixed(2) : '-';
                    minInhaleDisplay.textContent = (data.min_inhale < Infinity) ? data.min_inhale.toFixed(2) : '-';
                    longestExhaleDisplay.textContent = data.longest_exhale.toFixed(1);
                    longestInhaleDisplay.textContent = data.longest_inhale.toFixed(1);
                } catch(e) {
                     console.error('Error parsing measurement JSON:', e);
                }
            } else if (type === 'ERROR') {
                statusDisplay.textContent = 'Fout van apparaat: ' + line.substring(6);
                statusDisplay.className = 'status disconnected';
            }
        }

        function updateUiWithSettings(settings) {
            controlMode.value = settings.control_mode || 'joystick';
            controlMode.onchange();
            
            // Joystick instellingen
            deadzone.value = settings.deadzone || 0.02;
            deadzoneValue.textContent = settings.deadzone || 0.02;
            sensitivity.value = settings.sensitivity || 2.0;
            sensitivityValue.textContent = settings.sensitivity || 2.0;
            blowDirection.value = settings.blow_direction || 'right';
            inhaleDirection.value = settings.inhale_direction || 'left';
            
            // Gamepad knop instellingen
            blowButton.value = settings.blow_button || 'none';
            inhaleButton.value = settings.inhale_button || 'none';
            blowThreshold.value = settings.blow_threshold || 0.5;
            blowThresholdValue.textContent = settings.blow_threshold || 0.5;
            inhaleThreshold.value = settings.inhale_threshold || 0.5;
            inhaleThresholdValue.textContent = settings.inhale_threshold || 0.5;
            
            // GPIO trigger instellingen
            blowGpioThreshold.value = settings.blow_gpio_threshold || 0.7;
            blowGpioThresholdValue.textContent = settings.blow_gpio_threshold || 0.7;
            inhaleGpioThreshold.value = settings.inhale_gpio_threshold || -0.7;
            inhaleGpioThresholdValue.textContent = settings.inhale_gpio_threshold || -0.7;
            
            // LED instellingen
            ledEnabled.checked = settings.led_enabled !== false;
            ledStartBrightness.value = (settings.led_start_brightness || 0.05) * 100;
            ledStartBrightnessValue.textContent = Math.round((settings.led_start_brightness || 0.05) * 100);
            ledColorMode.value = settings.led_color_mode || 'rainbow';
            ledColorMode.onchange();
            if (settings.led_single_color) {
                const [r, g, b] = settings.led_single_color;
                ledSingleColor.value = `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            }
            
            // PEP modus instellingen
            pepModeEnabled.checked = settings.pep_mode_enabled || false;
            pepTargetValue.value = settings.pep_target_value || 0.8;
            pepTargetValueDisplay.textContent = settings.pep_target_value || 0.8;
            pepHoldTime.value = settings.pep_hold_time || 2.0;
            pepHoldTimeDisplay.textContent = settings.pep_hold_time || 2.0;
            pepStartBrightness.value = (settings.pep_start_brightness || 0.3) * 100;
            pepStartBrightnessValue.textContent = Math.round((settings.pep_start_brightness || 0.3) * 100);
            pepMaxBrightness.value = (settings.pep_max_brightness || 1.0) * 100;
            pepMaxBrightnessValue.textContent = Math.round((settings.pep_max_brightness || 1.0) * 100);
            pepBlinkTimes.value = settings.pep_blink_times || 3;
            pepBlinkTimesValue.textContent = settings.pep_blink_times || 3;
            pepBlinkSpeed.value = settings.pep_blink_speed || 0.2;
            pepBlinkSpeedValue.textContent = settings.pep_blink_speed || 0.2;
            
            // MP3 speler instellingen
            dfplayerEnabled.checked = settings.dfplayer_enabled || false;
            minVolume.value = settings.min_volume || 5;
            minVolumeValue.textContent = settings.min_volume || 5;
            maxVolume.value = settings.max_volume || 30;
            maxVolumeValue.textContent = settings.max_volume || 30;
            trackChangeThreshold.value = settings.track_change_threshold || -0.5;
            trackChangeThresholdValue.textContent = settings.track_change_threshold || -0.5;
        }

        connectionButton.onclick = async () => {
            if (port) {
                await disconnect();
            } else {
                await connect();
            }
        };

        saveButton.onclick = async () => {
            console.log("Save button clicked");
            
            // Converteer hex kleur naar RGB array
            const hexToRgb = (hex) => {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return [r, g, b];
            };

            // Valideer numerieke waarden
            const safeParseFloat = (value, defaultValue) => {
                const parsed = parseFloat(value);
                return isNaN(parsed) ? defaultValue : parsed;
            };

            const safeParseInt = (value, defaultValue) => {
                const parsed = parseInt(value);
                return isNaN(parsed) ? defaultValue : parsed;
            };

            try {
                const settings = {
                    control_mode: controlMode.value,
                    
                    // Joystick instellingen
                    deadzone: safeParseFloat(deadzone.value, 0.02),
                    sensitivity: safeParseFloat(sensitivity.value, 2.0),
                    blow_direction: blowDirection.value,
                    inhale_direction: inhaleDirection.value,
                    
                    // Gamepad knop instellingen
                    blow_button: blowButton.value,
                    inhale_button: inhaleButton.value,
                    blow_threshold: safeParseFloat(blowThreshold.value, 0.5),
                    inhale_threshold: safeParseFloat(inhaleThreshold.value, 0.5),
                    
                    // GPIO trigger instellingen
                    blow_gpio_threshold: safeParseFloat(blowGpioThreshold.value, 0.7),
                    inhale_gpio_threshold: safeParseFloat(inhaleGpioThreshold.value, -0.7),
                    
                    // LED instellingen
                    led_enabled: ledEnabled.checked,
                    led_start_brightness: safeParseFloat(ledStartBrightness.value, 5) / 100,
                    led_max_brightness: 1.0,
                    led_color_mode: ledColorMode.value,
                    led_single_color: hexToRgb(ledSingleColor.value),
                    
                    // PEP modus instellingen
                    pep_mode_enabled: pepModeEnabled.checked,
                    pep_target_value: safeParseFloat(pepTargetValue.value, 0.8),
                    pep_hold_time: safeParseFloat(pepHoldTime.value, 2.0),
                    pep_start_color: [255, 0, 0],
                    pep_success_color: [0, 255, 0],
                    pep_start_brightness: safeParseFloat(pepStartBrightness.value, 30) / 100,
                    pep_max_brightness: safeParseFloat(pepMaxBrightness.value, 100) / 100,
                    pep_blink_times: safeParseInt(pepBlinkTimes.value, 3),
                    pep_blink_speed: safeParseFloat(pepBlinkSpeed.value, 0.2),
                    
                    // MP3 speler instellingen
                    dfplayer_enabled: dfplayerEnabled.checked,
                    min_volume: safeParseInt(minVolume.value, 5),
                    max_volume: safeParseInt(maxVolume.value, 30),
                    track_change_threshold: safeParseFloat(trackChangeThreshold.value, -0.5)
                };
                
                console.log("Settings object:", settings);
                
                // Test JSON serialization
                const jsonString = JSON.stringify(settings);
                console.log("JSON string length:", jsonString.length);
                console.log("JSON string:", jsonString);
                
                // Send to device
                await sendCommand(`SET:settings::${jsonString}`);
                await new Promise(r => setTimeout(r, 100));
                await sendCommand('SAVE');
                
            } catch (error) {
                console.error("Error in save process:", error);
                alert("Fout bij opslaan: " + error.message);
            }
        };

        exportButton.onclick = async () => {
            console.log("Export button clicked");
            try {
                await sendCommand('EXPORT');
                alert('Instellingen geëxporteerd naar de console. Check de console logs voor de JSON export.');
            } catch (error) {
                console.error("Error in export process:", error);
                alert("Fout bij exporteren: " + error.message);
            }
        };

        importButton.onclick = async () => {
            console.log("Import button clicked");
            const jsonText = importTextarea.value.trim();
            if (!jsonText) {
                alert('Plak eerst JSON instellingen in het tekstvak.');
                return;
            }
            
            try {
                // Valideer JSON eerst
                JSON.parse(jsonText);
                
                await sendCommand(`IMPORT::${jsonText}`);
                alert('Instellingen succesvol geïmporteerd!');
                
                // Vraag updated settings op
                await new Promise(r => setTimeout(r, 100));
                await sendCommand('GET:settings');
                
            } catch (error) {
                console.error("Error in import process:", error);
                alert("Fout bij importeren: " + error.message);
            }
        };

        copyExportButton.onclick = async () => {
            console.log("Copy export button clicked");
            try {
                // Haal huidige instellingen van de UI
                const hexToRgb = (hex) => {
                    const r = parseInt(hex.slice(1, 3), 16);
                    const g = parseInt(hex.slice(3, 5), 16);
                    const b = parseInt(hex.slice(5, 7), 16);
                    return [r, g, b];
                };

                const safeParseFloat = (value, defaultValue) => {
                    const parsed = parseFloat(value);
                    return isNaN(parsed) ? defaultValue : parsed;
                };

                const safeParseInt = (value, defaultValue) => {
                    const parsed = parseInt(value);
                    return isNaN(parsed) ? defaultValue : parsed;
                };

                const currentSettings = {
                    control_mode: controlMode.value,
                    deadzone: safeParseFloat(deadzone.value, 0.02),
                    sensitivity: safeParseFloat(sensitivity.value, 2.0),
                    blow_direction: blowDirection.value,
                    inhale_direction: inhaleDirection.value,
                    blow_button: blowButton.value,
                    inhale_button: inhaleButton.value,
                    blow_threshold: safeParseFloat(blowThreshold.value, 0.5),
                    inhale_threshold: safeParseFloat(inhaleThreshold.value, 0.5),
                    blow_gpio_threshold: safeParseFloat(blowGpioThreshold.value, 0.7),
                    inhale_gpio_threshold: safeParseFloat(inhaleGpioThreshold.value, -0.7),
                    led_enabled: ledEnabled.checked,
                    led_start_brightness: safeParseFloat(ledStartBrightness.value, 5) / 100,
                    led_max_brightness: 1.0,
                    led_color_mode: ledColorMode.value,
                    led_single_color: hexToRgb(ledSingleColor.value),
                    pep_mode_enabled: pepModeEnabled.checked,
                    pep_target_value: safeParseFloat(pepTargetValue.value, 0.8),
                    pep_hold_time: safeParseFloat(pepHoldTime.value, 2.0),
                    pep_start_color: [255, 0, 0],
                    pep_success_color: [0, 255, 0],
                    pep_start_brightness: safeParseFloat(pepStartBrightness.value, 30) / 100,
                    pep_max_brightness: safeParseFloat(pepMaxBrightness.value, 100) / 100,
                    pep_blink_times: safeParseInt(pepBlinkTimes.value, 3),
                    pep_blink_speed: safeParseFloat(pepBlinkSpeed.value, 0.2),
                    dfplayer_enabled: dfplayerEnabled.checked,
                    min_volume: safeParseInt(minVolume.value, 5),
                    max_volume: safeParseInt(maxVolume.value, 30),
                    track_change_threshold: safeParseFloat(trackChangeThreshold.value, -0.5)
                };
                
                const jsonString = JSON.stringify(currentSettings, null, 2);
                importTextarea.value = jsonString;
                
                // Kopieer naar clipboard als beschikbaar
                if (navigator.clipboard) {
                    await navigator.clipboard.writeText(jsonString);
                    alert('Huidige instellingen gekopieerd naar klembord en tekstvak!');
                } else {
                    alert('Huidige instellingen geplaatst in tekstvak. Kopieer handmatig naar klembord.');
                }
                
            } catch (error) {
                console.error("Error in copy export process:", error);
                alert("Fout bij kopiëren: " + error.message);
            }
        };

        // <<<<<<< AANGEPAST: Logica voor meten met debug
        measureButton.onclick = async () => {
            isMeasuring = !isMeasuring;
            if (isMeasuring) {
                // Start de meting
                console.log("Starting measurement...");
                measureButton.textContent = 'Stop Meting';
                measurementResults.style.display = 'block';
                // Reset de display
                maxExhaleDisplay.textContent = '-';
                minInhaleDisplay.textContent = '-';
                longestExhaleDisplay.textContent = '-';
                longestInhaleDisplay.textContent = '-';
                await sendCommand('SET:measure:true');
                console.log("Sent SET:measure:true command");
            } else {
                // Stop de meting en vraag resultaten op
                console.log("Stopping measurement...");
                measureButton.textContent = 'Start Meting';
                await sendCommand('SET:measure:false');
                console.log("Sent SET:measure:false command");
                await new Promise(r => setTimeout(r, 200)); // Langere pauze
                console.log("Requesting measurement results...");
                await sendCommand('GET:measurements');
                console.log("Sent GET:measurements command");
            }
        };

        if (!navigator.serial) {
            connectionButton.disabled = true;
            statusDisplay.textContent = 'Web Serial API wordt niet ondersteund in deze browser. Gebruik Chrome of Edge.';
            statusDisplay.className = 'status disconnected';
        }
    </script>
</body>
</html>